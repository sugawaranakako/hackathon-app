🚀 Initializing Vertex AI with: {
  projectId: 'xtone-devadmin',
  location: 'us-east5',
  model: 'claude-3-5-sonnet@20241022',
  credentialsPath: '/Users/oyanagi/xtone-devadmin-50de693ffbd6.json'
}
🚀 Server is running on port 3001
📊 Health check: http://localhost:3001/api/health
🧪 Vertex AI test: http://localhost:3001/api/test-vertex
🧅 API endpoints available:
   - POST /api/optimize-ingredients
   - POST /api/cooking-chat
   - POST /api/suggest-improvements
🔑 Authentication status:
   - Project: xtone-devadmin
   - Location: us-east5
   - Credentials: ✅ Set
=== 🧅 optimize-ingredients-v2 API called ===
Request body: {
  "recipe": {
    "id": "test-debug",
    "name": "デバッグテスト",
    "ingredients": [
      "鶏もも肉 200g",
      "醤油 大さじ2",
      "みりん 大さじ1"
    ],
    "instructions": [
      "鶏肉を焼く"
    ]
  },
  "ingredientAdjustments": [
    {
      "ingredient": "鶏もも肉",
      "originalAmount": "200g",
      "newAmount": "400g"
    }
  ]
}
Received recipe: {
  "id": "test-debug",
  "name": "デバッグテスト",
  "ingredients": [
    "鶏もも肉 200g",
    "醤油 大さじ2",
    "みりん 大さじ1"
  ],
  "instructions": [
    "鶏肉を焼く"
  ]
}
Received adjustments: [
  {
    "ingredient": "鶏もも肉",
    "originalAmount": "200g",
    "newAmount": "400g"
  }
]
📝 Validated request data:
Recipe name: デバッグテスト
Ingredients count: 3
Adjustments count: 1
🤖 Calling Claude API...
📤 Sending to Claude:
System Prompt: あなたは料理のプロフェッショナルです。ユーザーが食材の分量を変更した際に、料理全体のバランスを保つための包括的な調整案を提案してください。

以下の要素について必ず提案してください：
1. 調味料の調整（食材の増減に合わせて比例調整）
2. 作り方の調整（調理時間や手順の変更）
3. 実用的なアドバイス（保存方法、アレンジ案など）

【重要】レスポンスは必ず以下のJSON形式で返してください：
{
  "ingredientChanges": [
    {"ingredient": "食材名", "originalAmount": "元の分量", "newAmount": "新しい分量"}
  ],
  "seasoningAdjustments": [
    {"ingredient": "調味料名", "originalAmount": "元の分量", "adjustedAmount": "調整後分量", "reason": "調整理由"}
  ],
  "cookingAdjustments": [
    {"step": "手順番号", "adjustment": "調整内容"}
  ],
  "advice": ["アドバイス1", "アドバイス2"]
}
User Message: 
【レシピ：デバッグテスト】

【現在の材料】
1. 鶏もも肉 200g
2. 醤油 大さじ2
3. みりん 大さじ1

【ユーザーの食材調整】
- 鶏もも肉: 200g → 400g

【作り方】（参考）
鶏肉を焼く

この調整に対して、以下を含む包括的な最適化案を提案してください：

1. 調味料の比例調整（味のバランスを保つため）
2. 作り方の調整（調理時間、火加減、手順の変更）
3. 実用的なアドバイス（保存、アレンジ、注意点など）

必ずJSON形式で回答してください。
📡 callClaude called with: {
  messagesCount: 1,
  hasSystemPrompt: true,
  model: 'claude-3-5-sonnet@20241022'
}
🔧 Creating generative model...
💬 Formatting messages...
🗣️ Starting chat session...
📤 Sending message to Claude...
❌ callClaude error details:
Error type: ClientError
Error message: [VertexAI.ClientError]: got status: 404 Not Found. {"error":{"code":404,"message":"Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.","status":"NOT_FOUND"}}
Error code: undefined
Error details: undefined
Model used: claude-3-5-sonnet@20241022
Project: xtone-devadmin
Location: us-east5
Full error: ClientError: [VertexAI.ClientError]: got status: 404 Not Found. {"error":{"code":404,"message":"Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.","status":"NOT_FOUND"}}
    at throwErrorIfNotOK (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/functions/post_fetch_processing.js:32:27)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    ... 3 lines matching cause stack trace ...
    at async /Users/oyanagi/Projects/hackathon-app/recipe-app/server.js:558:20 {
  stackTrace: GoogleApiError: Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.
      at throwErrorIfNotOK (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/functions/post_fetch_processing.js:32:66)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
      at async generateContent (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/functions/generate_content.js:59:5)
      at async ChatSessionPreview.sendMessage (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/models/chat_session.js:242:39)
      at async callClaude (/Users/oyanagi/Projects/hackathon-app/recipe-app/server.js:67:20)
      at async /Users/oyanagi/Projects/hackathon-app/recipe-app/server.js:558:20 {
    code: 404,
    status: 'NOT_FOUND',
    errorDetails: undefined
  },
  [cause]: GoogleApiError: Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.
      at throwErrorIfNotOK (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/functions/post_fetch_processing.js:32:66)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
      at async generateContent (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/functions/generate_content.js:59:5)
      at async ChatSessionPreview.sendMessage (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/models/chat_session.js:242:39)
      at async callClaude (/Users/oyanagi/Projects/hackathon-app/recipe-app/server.js:67:20)
      at async /Users/oyanagi/Projects/hackathon-app/recipe-app/server.js:558:20 {
    code: 404,
    status: 'NOT_FOUND',
    errorDetails: undefined
  }
}
=== Claude API Response V2 ===
{
  "success": false,
  "error": "[VertexAI.ClientError]: got status: 404 Not Found. {\"error\":{\"code\":404,\"message\":\"Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.\",\"status\":\"NOT_FOUND\"}}"
}
❌ Claude API failed: [VertexAI.ClientError]: got status: 404 Not Found. {"error":{"code":404,"message":"Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.","status":"NOT_FOUND"}}
🔄 Generating comprehensive fallback response...
🧂 調味料調整分析: {
  avgIncreaseRate: 2,
  needsAdjustment: true,
  ratios: [ 2 ],
  isSimpleProportional: true,
  seasoningsCount: 2
}
=== 🧅 optimize-ingredients-v2 API called ===
Request body: {
  "recipe": {
    "id": "test-info",
    "name": "情報テスト",
    "ingredients": [
      "鶏もも肉 200g",
      "醤油 大さじ2",
      "みりん 大さじ1"
    ],
    "instructions": [
      "鶏肉を焼く"
    ]
  },
  "ingredientAdjustments": [
    {
      "ingredient": "鶏もも肉",
      "originalAmount": "200g",
      "newAmount": "400g"
    }
  ]
}
Received recipe: {
  "id": "test-info",
  "name": "情報テスト",
  "ingredients": [
    "鶏もも肉 200g",
    "醤油 大さじ2",
    "みりん 大さじ1"
  ],
  "instructions": [
    "鶏肉を焼く"
  ]
}
Received adjustments: [
  {
    "ingredient": "鶏もも肉",
    "originalAmount": "200g",
    "newAmount": "400g"
  }
]
📝 Validated request data:
Recipe name: 情報テスト
Ingredients count: 3
Adjustments count: 1
🤖 Calling Claude API...
📤 Sending to Claude:
System Prompt: あなたは料理のプロフェッショナルです。ユーザーが食材の分量を変更した際に、料理全体のバランスを保つための包括的な調整案を提案してください。

以下の要素について必ず提案してください：
1. 調味料の調整（食材の増減に合わせて比例調整）
2. 作り方の調整（調理時間や手順の変更）
3. 実用的なアドバイス（保存方法、アレンジ案など）

【重要】レスポンスは必ず以下のJSON形式で返してください：
{
  "ingredientChanges": [
    {"ingredient": "食材名", "originalAmount": "元の分量", "newAmount": "新しい分量"}
  ],
  "seasoningAdjustments": [
    {"ingredient": "調味料名", "originalAmount": "元の分量", "adjustedAmount": "調整後分量", "reason": "調整理由"}
  ],
  "cookingAdjustments": [
    {"step": "手順番号", "adjustment": "調整内容"}
  ],
  "advice": ["アドバイス1", "アドバイス2"]
}
User Message: 
【レシピ：情報テスト】

【現在の材料】
1. 鶏もも肉 200g
2. 醤油 大さじ2
3. みりん 大さじ1

【ユーザーの食材調整】
- 鶏もも肉: 200g → 400g

【作り方】（参考）
鶏肉を焼く

この調整に対して、以下を含む包括的な最適化案を提案してください：

1. 調味料の比例調整（味のバランスを保つため）
2. 作り方の調整（調理時間、火加減、手順の変更）
3. 実用的なアドバイス（保存、アレンジ、注意点など）

必ずJSON形式で回答してください。
📡 callClaude called with: {
  messagesCount: 1,
  hasSystemPrompt: true,
  model: 'claude-3-5-sonnet@20241022'
}
🔧 Creating generative model...
💬 Formatting messages...
🗣️ Starting chat session...
📤 Sending message to Claude...
❌ callClaude error details:
Error type: ClientError
Error message: [VertexAI.ClientError]: got status: 404 Not Found. {"error":{"code":404,"message":"Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.","status":"NOT_FOUND"}}
Error code: undefined
Error details: undefined
Model used: claude-3-5-sonnet@20241022
Project: xtone-devadmin
Location: us-east5
Full error: ClientError: [VertexAI.ClientError]: got status: 404 Not Found. {"error":{"code":404,"message":"Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.","status":"NOT_FOUND"}}
    at throwErrorIfNotOK (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/functions/post_fetch_processing.js:32:27)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    ... 3 lines matching cause stack trace ...
    at async /Users/oyanagi/Projects/hackathon-app/recipe-app/server.js:558:20 {
  stackTrace: GoogleApiError: Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.
      at throwErrorIfNotOK (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/functions/post_fetch_processing.js:32:66)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
      at async generateContent (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/functions/generate_content.js:59:5)
      at async ChatSessionPreview.sendMessage (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/models/chat_session.js:242:39)
      at async callClaude (/Users/oyanagi/Projects/hackathon-app/recipe-app/server.js:67:20)
      at async /Users/oyanagi/Projects/hackathon-app/recipe-app/server.js:558:20 {
    code: 404,
    status: 'NOT_FOUND',
    errorDetails: undefined
  },
  [cause]: GoogleApiError: Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.
      at throwErrorIfNotOK (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/functions/post_fetch_processing.js:32:66)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
      at async generateContent (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/functions/generate_content.js:59:5)
      at async ChatSessionPreview.sendMessage (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/models/chat_session.js:242:39)
      at async callClaude (/Users/oyanagi/Projects/hackathon-app/recipe-app/server.js:67:20)
      at async /Users/oyanagi/Projects/hackathon-app/recipe-app/server.js:558:20 {
    code: 404,
    status: 'NOT_FOUND',
    errorDetails: undefined
  }
}
=== Claude API Response V2 ===
{
  "success": false,
  "error": "[VertexAI.ClientError]: got status: 404 Not Found. {\"error\":{\"code\":404,\"message\":\"Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.\",\"status\":\"NOT_FOUND\"}}"
}
❌ Claude API failed: [VertexAI.ClientError]: got status: 404 Not Found. {"error":{"code":404,"message":"Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.","status":"NOT_FOUND"}}
🔄 Generating comprehensive fallback response...
🧂 調味料調整分析: {
  avgIncreaseRate: 2,
  needsAdjustment: true,
  ratios: [ 2 ],
  isSimpleProportional: true,
  seasoningsCount: 2
}
=== 🧅 optimize-ingredients-v2 API called ===
Request body: {
  "recipe": {
    "id": "test-no-adjustment",
    "name": "調整不要テスト",
    "ingredients": [
      "鶏もも肉 200g",
      "醤油 大さじ2",
      "みりん 大さじ1"
    ],
    "instructions": [
      "鶏肉を焼く"
    ]
  },
  "ingredientAdjustments": [
    {
      "ingredient": "鶏もも肉",
      "originalAmount": "200g",
      "newAmount": "210g"
    }
  ]
}
Received recipe: {
  "id": "test-no-adjustment",
  "name": "調整不要テスト",
  "ingredients": [
    "鶏もも肉 200g",
    "醤油 大さじ2",
    "みりん 大さじ1"
  ],
  "instructions": [
    "鶏肉を焼く"
  ]
}
Received adjustments: [
  {
    "ingredient": "鶏もも肉",
    "originalAmount": "200g",
    "newAmount": "210g"
  }
]
📝 Validated request data:
Recipe name: 調整不要テスト
Ingredients count: 3
Adjustments count: 1
🤖 Calling Claude API...
📤 Sending to Claude:
System Prompt: あなたは料理のプロフェッショナルです。ユーザーが食材の分量を変更した際に、料理全体のバランスを保つための包括的な調整案を提案してください。

以下の要素について必ず提案してください：
1. 調味料の調整（食材の増減に合わせて比例調整）
2. 作り方の調整（調理時間や手順の変更）
3. 実用的なアドバイス（保存方法、アレンジ案など）

【重要】レスポンスは必ず以下のJSON形式で返してください：
{
  "ingredientChanges": [
    {"ingredient": "食材名", "originalAmount": "元の分量", "newAmount": "新しい分量"}
  ],
  "seasoningAdjustments": [
    {"ingredient": "調味料名", "originalAmount": "元の分量", "adjustedAmount": "調整後分量", "reason": "調整理由"}
  ],
  "cookingAdjustments": [
    {"step": "手順番号", "adjustment": "調整内容"}
  ],
  "advice": ["アドバイス1", "アドバイス2"]
}
User Message: 
【レシピ：調整不要テスト】

【現在の材料】
1. 鶏もも肉 200g
2. 醤油 大さじ2
3. みりん 大さじ1

【ユーザーの食材調整】
- 鶏もも肉: 200g → 210g

【作り方】（参考）
鶏肉を焼く

この調整に対して、以下を含む包括的な最適化案を提案してください：

1. 調味料の比例調整（味のバランスを保つため）
2. 作り方の調整（調理時間、火加減、手順の変更）
3. 実用的なアドバイス（保存、アレンジ、注意点など）

必ずJSON形式で回答してください。
📡 callClaude called with: {
  messagesCount: 1,
  hasSystemPrompt: true,
  model: 'claude-3-5-sonnet@20241022'
}
🔧 Creating generative model...
💬 Formatting messages...
🗣️ Starting chat session...
📤 Sending message to Claude...
❌ callClaude error details:
Error type: ClientError
Error message: [VertexAI.ClientError]: got status: 404 Not Found. {"error":{"code":404,"message":"Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.","status":"NOT_FOUND"}}
Error code: undefined
Error details: undefined
Model used: claude-3-5-sonnet@20241022
Project: xtone-devadmin
Location: us-east5
Full error: ClientError: [VertexAI.ClientError]: got status: 404 Not Found. {"error":{"code":404,"message":"Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.","status":"NOT_FOUND"}}
    at throwErrorIfNotOK (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/functions/post_fetch_processing.js:32:27)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    ... 3 lines matching cause stack trace ...
    at async /Users/oyanagi/Projects/hackathon-app/recipe-app/server.js:558:20 {
  stackTrace: GoogleApiError: Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.
      at throwErrorIfNotOK (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/functions/post_fetch_processing.js:32:66)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
      at async generateContent (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/functions/generate_content.js:59:5)
      at async ChatSessionPreview.sendMessage (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/models/chat_session.js:242:39)
      at async callClaude (/Users/oyanagi/Projects/hackathon-app/recipe-app/server.js:67:20)
      at async /Users/oyanagi/Projects/hackathon-app/recipe-app/server.js:558:20 {
    code: 404,
    status: 'NOT_FOUND',
    errorDetails: undefined
  },
  [cause]: GoogleApiError: Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.
      at throwErrorIfNotOK (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/functions/post_fetch_processing.js:32:66)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
      at async generateContent (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/functions/generate_content.js:59:5)
      at async ChatSessionPreview.sendMessage (/Users/oyanagi/Projects/hackathon-app/recipe-app/node_modules/@google-cloud/vertexai/build/src/models/chat_session.js:242:39)
      at async callClaude (/Users/oyanagi/Projects/hackathon-app/recipe-app/server.js:67:20)
      at async /Users/oyanagi/Projects/hackathon-app/recipe-app/server.js:558:20 {
    code: 404,
    status: 'NOT_FOUND',
    errorDetails: undefined
  }
}
=== Claude API Response V2 ===
{
  "success": false,
  "error": "[VertexAI.ClientError]: got status: 404 Not Found. {\"error\":{\"code\":404,\"message\":\"Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.\",\"status\":\"NOT_FOUND\"}}"
}
❌ Claude API failed: [VertexAI.ClientError]: got status: 404 Not Found. {"error":{"code":404,"message":"Publisher Model `projects/xtone-devadmin/locations/us-east5/publishers/google/models/claude-3-5-sonnet@20241022` not found.","status":"NOT_FOUND"}}
🔄 Generating comprehensive fallback response...
